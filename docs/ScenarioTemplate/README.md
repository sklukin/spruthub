# В данном разделе собрана документация по логическим сценариям для Sprut.hub, а так же шаблон для них

> **Автор документации:** [Kirill Ashikhmin (@KirillAshikhmin)](https://github.com/KirillAshikhmin)
> **Источник:** [Sprut.Hub_Tools](https://github.com/KirillAshikhmin/Sprut.Hub_Tools)

Сценарии пишутся на Языке JavaScript на движке Nashorn и поддерживает только стандарт ES5 (ECMAScript 5), с некоторыми функциями из ES6.
Поддерживаемые в Nashorn функции из ES6:
- Стрелочные функции (Arrow functions)
- Шаблонные строки (Template literals)
- const и let ключевые слова для объявления переменных
- Map и Set коллекции
- Цикл for...of
Все остальыне функции (Деструктуризация, классы, модули, промисы и т.д.) не поддерживаются!

Принципы которые применять:
"Минимум кода и максимум читаемости. Читаемость в приоритете"
Single Responsibility Principle - каждая функция делает одну вещь
DRY (Don't Repeat Yourself) - убрано дублирование кода
Early Returns - избегание глубоких вложений
Meaningful Names - понятные имена переменных и функций
Constants over Magic Numbers - использование констант


## Дополнительная информация
Файл [sh_types.json](./sh_types.json) - содержит список всех доступных сервисов в хабе со всеми свойствами, а так же характеристики, которые могут содержаться в этом сервисе и их формат и допустимые значения.

Файл [spruthub.js](./spruthub.js) - JS API Sprut.Hub со всеми доступными в нем функциями с документацией на русском языке

## Основные понятия

### HS (Service) - Типы сервисов
HS - это перечисление (enum) всех доступных типов сервисов в Sprut.Hub. Каждый сервис представляет собой функциональную группу характеристик устройства. Например:
- `HS.Lightbulb` - сервис лампочки
- `HS.Switch` - сервис выключателя  
- `HS.TemperatureSensor` - сервис датчика температуры
- `HS.HumiditySensor` - сервис датчика влажности

### HC (Characteristic) - Типы характеристик
HC - это перечисление (enum) всех доступных типов характеристик в Sprut.Hub. Характеристики определяют конкретные свойства и состояния устройств. Например:
- `HC.On` - включение/выключение устройства
- `HC.Brightness` - яркость (для ламп)
- `HC.CurrentTemperature` - текущая температура
- `HC.CurrentRelativeHumidity` - текущая влажность
- `HC.TargetTemperature` - целевая температура

Структура устройств: Каждое устройство это аксессуар (Accessory). В каждом аксессуаре может быть 1 или более сервисов (Service). В сервисе, в свою очередь 1 или более характеристика (Characteristic). Однако для каждого сервиса список достустимых характеристик ограничен. Узнать какие характеристики могут быть в сервисе можно изучив файл sh_types.json или посмотрев в интерфейсе хаба в разделе Настройки - Типы сервисов. Аксессуар может содержать неограниченное количество сервисов с одинаковыми или разными типами. Характеристики же не более 1 штуки каждого поддерживаемого типа в сервисе.



# Написание сценариев
## Логические

### Подготовка
1. Создать новый пустой логический сценарий в интерфейсе хаба.
2. Скопировать в него шаблон:
```javascript
info = {
  name: "Название сценария",
  description: "Описание сценария",
  version: "1.0",
  author: "@Author",
  onStart: true,
  sourceServices: [HS.Switch],        // Реагирует на изменения в сервисах типа Switch
  sourceCharacteristics: [HC.On],     // Реагирует на изменения характеристики On
  options: {},
  variables: {}
}
```

function trigger(source, value, variables, options, context) {

}
```

### Структура сценария

Логический сценарий состоит из нескольких основных блоков:

### 1. Блок info
Основной блок, описывающий сценарий.
Важно. Значение поля info хаб считывает во время запуска и сохранения сценария, соответственно работать с ним из кода нельзя (точнее фактически можно, но это не правильно, и объект только для чтения, значения переменных туда не записать и опции не будут содержать значений). Все нужные значения необходимо получать из переменных, которые приходят в функцию trigger или compute.

#### Обязательные поля:
- `name` - название сценария
- `description` - описание функционала
- `version` - номер версии
- `author` - автор сценария
- `onStart` - если true, функция trigger будет вызвана при включении хаба и сохранении сценария
- `sourceServices` - список типов устройств, на изменения которых реагирует сценарий (используйте значения из enum HS, например: `[HS.Switch, HS.Lightbulb]`)
- `sourceCharacteristics` - список характеристик, на изменения которых реагирует сценарий (используйте значения из enum HC, например: `[HC.On, HC.Brightness]`)

#### Опции (options)
Опции отображаются в интерфейсе хаба в настройках логики для каждого устройства индивидуально. Определяются так же в блоке info в поле options.

##### Доступные типы полей опций:

1. **Boolean** - логическое значение (true/false)
2. **Integer** - целое число с диапазоном
3. **Double** - дробное число с диапазоном
4. **String** - строковое значение
5. **Enum** - выбор из списка (тип может быть любым из перечисленных выше, главное что бы значение в поле value опции и допустимых значений были того же типа). Отличие от других типов - нужно указать valus с списком допустимых значений и `formType: "list",`

#### Переменные (variables)
Объект для хранения данных сценария. Значения доступны только в рамках сценария и сбрасываются при перезагрузке хаба. Можно хранить любое значение для последующего использования в коде.

**ВАЖНО:** Объект `variables` уникален для каждого датчика/устройства, а не общий для всего сценария. Поэтому `variables.initialized = true` в одном триггере не виден в другом.

#### Однократная инициализация

Для выполнения кода один раз при загрузке сценария (например, создание cron-задач) используйте паттерн с версией скрипта:

```javascript
// Уникальная версия при загрузке сценария
var SCRIPT_VERSION = Date.now();
var _lastInitVersion = 0;
var _cronTask = null;

function trigger(source, value, variables, options, context) {
    // Инициализация выполнится только один раз
    if (_lastInitVersion !== SCRIPT_VERSION) {
        _lastInitVersion = SCRIPT_VERSION;

        // Очистка старых задач при перезагрузке сценария
        if (_cronTask) {
            try { clear(_cronTask); } catch(e) {}
        }

        _cronTask = Cron.schedule("0 0 * * * *", function() {
            // Код выполняемый по расписанию
        });
        log.info("Инициализация завершена");
    }

    // Основной код триггера
}
```

Этот паттерн работает потому что:
- `SCRIPT_VERSION` генерируется один раз при загрузке скрипта
- Первый триггер видит несовпадение версий и выполняет инициализацию
- Последующие триггеры видят совпадение и пропускают
- При перезагрузке сценария генерируется новая версия

#### Cron-расписания

SprutHub использует **6-полевой формат cron** (с секундами):

```
секунда минута час день месяц день_недели
```

Примеры:
- `"0 0 * * * *"` — каждый час (в 0 секунд 0 минут)
- `"0 * * * * *"` — каждую минуту
- `"0 0,30 * * * *"` — каждые 30 минут
- `"0 0 8 * * *"` — каждый день в 8:00

**ВАЖНО:** Стандартный 5-полевой cron (без секунд) вызовет ошибку!

#### Telegram-уведомления

Для отправки сообщений в Telegram используйте глобальную функцию:

```javascript
global.sendToTelegram("Текст сообщения");
```

Не реализуйте отправку через HttpClient вручную.

#### Options vs Constants

- **Опции (`info.options`)** — для настроек, относящихся к **конкретному датчику/устройству**
- **Константы** — для настроек сценария в целом (URL серверов, cron-расписания, вкл/выкл функций)

```javascript
// Константы сценария (не опции!)
var SERVER_URL = 'http://192.168.1.1:8080';
var CRON_SCHEDULE = "0 0 * * * *";
var ENABLE_FEATURE = true;

info = {
    options: {
        // Только настройки для конкретного датчика
        ShowDebugLog: {
            name: { en: "Show debug log", ru: "Показать отладку" },
            type: "Boolean",
            value: false
        }
    }
}
```

#### Функции

#### trigger
Основная функция сценария.
Является главной функцией и точкой входа в сценарии.
Вызывается системой после выполнения compute и фактической установки значения. 
Вызывается после выполнения функции compute и фактической установки значения в хабе.
при включённом onStart в блоке info вызывается при запуске хаба и при сохранении сценария с текущим значением характеристики.
Работает ассинхронно.
```javascript
function trigger(source, value, variables, options, context) {
  // Код сценария
}
```

#### compute
Синхронная функция, вызывается при изменении характеристики. Результат устанавливается в характеристику.
ВНИМАНИЕ! Функция выполняется синхронно и может замедлять работу хаба или приводить к неожиданному поведению.
Применять только при острой необходимости и с особой осторожностью. Не выполнять в ней сложных вычислений или долгих операций.
```javascript
function compute(source, value, variables, options, context) {
  return value;
}
```

#### Кастомные функции
Вы можете в коде сценария создавать любые свои функции, которые будут доступны только в рамках данного сценария, и которые можно вызывать из функций trigger или compute.

### Особенности API 
Система при вызове getUUID() у аксессуара возвращает строку с числовым идентификатором аксессуара. Если getUUID() вызвать у сервиса, то в ответ будет строка "ID аксессуара.ID сервиса", а для характеристики будет значение "ID аксессуара.ID сервиса.ID характеристики"

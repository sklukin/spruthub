# Outlet Scheduler

Сценарий для управления розетками по расписанию. Каждая розетка включается автоматически по cron и выключается через заданное время.

## Возможности

- Управление несколькими розетками с индивидуальными расписаниями
- Выбор расписания из предустановленных вариантов
- Настраиваемая длительность включения для каждой розетки
- Автоматическое создание расписания при запуске хаба

## Требования

- SprutHub с розетками (HS.Outlet)

## Установка

### 1. Добавление в SprutHub

1. Скопируйте содержимое `logic/outletScheduler.js`
2. В SprutHub создайте новый логический сценарий
3. Вставьте код сценария
4. Сохраните сценарий

### 2. Активация для розетки

1. Перейдите в настройки розетки (Outlet)
2. Включите сценарий "Outlet Scheduler"
3. Выберите расписание из списка
4. Укажите длительность включения в минутах
5. Повторите для всех нужных розеток

## Опции сценария

| Опция | Тип | Описание |
| ----- | --- | -------- |
| Расписание | Список | Как часто включать розетку |
| Длительность | Integer | На сколько минут включать (1-1440) |

### Варианты расписания

| Значение | Cron-выражение | Описание |
| -------- | -------------- | -------- |
| Каждые 15 минут | `0 0,15,30,45 * * * *` | В :00, :15, :30, :45 каждого часа |
| Каждые 30 минут | `0 0,30 * * * *` | В :00 и :30 каждого часа |
| Каждый час | `0 0 * * * *` | В начале каждого часа |
| Каждые 2 часа | `0 0 */2 * * *` | В 00:00, 02:00, 04:00... |
| Каждые 6 часов | `0 0 */6 * * *` | В 00:00, 06:00, 12:00, 18:00 |
| Раз в сутки | `0 0 0 * * *` | В полночь |

## Как работает сценарий

### Инициализация

При первом вызове `trigger()` для каждой розетки:

1. Сценарий получает настройки из опций (расписание, длительность)
2. Создаёт cron-задачу для этой розетки
3. Сохраняет задачу в `variables.cronTask`

### Цикл работы

```
Cron-время наступило
    ↓
Розетка включается
    ↓
Ждём N минут (setTimeout)
    ↓
Розетка выключается
```

### При перезагрузке сценария

- `variables.cronTask` сбрасывается
- При следующем `trigger()` создаётся новая cron-задача

## Примеры использования

### Аквариумный компрессор

- Расписание: Каждый час
- Длительность: 15 минут
- Результат: Компрессор работает 15 минут каждый час

### Увлажнитель воздуха

- Расписание: Каждые 2 часа
- Длительность: 30 минут
- Результат: Увлажнитель включается каждые 2 часа на полчаса

### Полив растений

- Расписание: Раз в сутки (полночь)
- Длительность: 5 минут
- Результат: Полив каждый день в 00:00 на 5 минут

## Устранение неполадок

### Расписание не работает

1. Проверьте логи SprutHub на сообщение "Расписание создано для: ..."
2. Убедитесь что розетка добавлена в сценарий
3. Сохраните сценарий заново

### Розетка не выключается

1. Проверьте что длительность указана корректно (1-1440 минут)
2. Убедитесь что розетка доступна в сети

### Несколько розеток с одинаковым расписанием

Это нормально — каждая розетка имеет своё независимое расписание через опции.

## Тестирование

Для локального тестирования:

```bash
cd /path/to/spruthub
node logic/test-runner.js
```

## Структура файлов

```
logic/
├── outletScheduler.js    # Сценарий управления розетками
└── test-runner.js        # Тестовый раннер для Node.js

docs/
└── outletScheduler-setup.md   # Эта документация
```

## Валидация длительности

Сценарий автоматически проверяет, что длительность не превышает период расписания:

| Расписание | Макс. длительность |
| ---------- | ------------------ |
| Каждые 15 минут | 15 мин |
| Каждые 30 минут | 30 мин |
| Каждый час | 60 мин |
| Каждые 2 часа | 120 мин |
| Каждые 6 часов | 360 мин |
| Раз в сутки | 1440 мин |

Если указана длительность больше периода, она будет автоматически ограничена с предупреждением в логах.

## Ограничения

- Ручное управление розеткой не влияет на расписание — если розетку выключить вручную, она всё равно выключится повторно по таймеру
- Минимальная длительность: 1 минута
- Максимальная длительность: зависит от выбранного расписания (см. таблицу выше)

# AWTRIX Temperature Display

Сценарий для отображения температуры с датчиков SprutHub на часах AWTRIX3.

## Возможности

- Отображение температуры со всех датчиков на всех часах AWTRIX
- Цвет текста меняется в зависимости от температуры
- Иконка термометра рядом с температурой
- Автоматическое отключение встроенных приложений AWTRIX (с перезагрузкой)
- Настраиваемые пороги температуры

## Требования

- SprutHub с датчиками температуры (HS.TemperatureSensor)
- Часы Ulanzi TC001 с прошивкой [AWTRIX 3](https://blueforcer.github.io/awtrix3/#/)
- Иконка термометра (ID 2056) — загружается вручную через веб-интерфейс часов

## Установка

### 1. Загрузка иконки на AWTRIX

1. Откройте веб-интерфейс часов: `http://<IP_часов>`
2. Перейдите в раздел Icons
3. Найдите и загрузите иконку с ID `2056` (термометр)

### 2. Настройка сценария

Откройте файл `logic/awtrixTemperature.js` и настройте константы:

#### Список часов AWTRIX

```javascript
const CLOCKS = [
    { name: "Кухня", ip: "192.168.1.65" },
    { name: "Спальня", ip: "192.168.1.66" }
];
```

Добавьте все ваши часы AWTRIX с их IP-адресами.

#### Цвета температуры

```javascript
const COLORS = {
    VERY_COLD: "#9400D3",  // фиолетовый
    COLD: "#0000FF",       // синий
    COMFORT: "#00FF00",    // зелёный
    HOT: "#FF0000"         // красный
};
```

#### Пороги температуры

```javascript
const VERY_COLD_THRESHOLD = 0;   // ниже — фиолетовый
const COLD_THRESHOLD = 18;       // ниже — синий
const HOT_THRESHOLD = 24;        // выше — красный
```

#### Настройки яркости

```javascript
const AUTO_BRIGHTNESS = true;      // Автоматическая яркость
const MANUAL_BRIGHTNESS = 150;     // Ручная яркость (0-255), если AUTO_BRIGHTNESS = false
```

#### Время отображения

```javascript
const APP_DISPLAY_TIME = 10;  // Секунды на каждое приложение
```

#### Задержка после перезагрузки

```javascript
const REBOOT_DELAY = 30000;  // 30 секунд ожидания после перезагрузки часов
```

#### Встроенные приложения AWTRIX

```javascript
const BUILTIN_APPS = {
    TIM: true,    // Время (рекомендуется оставить)
    DAT: false,   // Дата
    TEMP: false,  // Встроенная температура
    HUM: false,   // Влажность
    BAT: false    // Батарея
};
```

Установите `true` для приложений, которые хотите оставить.

### 3. Добавление в SprutHub

1. Скопируйте содержимое `logic/awtrixTemperature.js`
2. В SprutHub создайте новый логический сценарий
3. Вставьте код сценария
4. Сохраните сценарий

### 4. Активация для датчиков

1. Перейдите в настройки датчика температуры
2. Включите сценарий "AWTRIX Temperature Display"
3. Повторите для всех датчиков температуры

## Как работает сценарий

### Инициализация (при сохранении сценария)

При сохранении или загрузке сценария автоматически:
1. Отправляются настройки на все часы из списка CLOCKS:
   - Встроенные приложения (TIM, DAT, TEMP, HUM, BAT)
   - Яркость
   - Время отображения приложений
2. Часы перезагружаются для применения настроек
3. В течение 30 секунд все триггеры пропускаются (часы перезагружаются)

> **Примечание:** Часовой пояс настраивается через веб-интерфейс часов (вкладка Time), а не через сценарий.

### Нормальная работа

После 30 секунд при каждом изменении температуры датчика:
1. Сценарий формирует приложение с температурой и названием комнаты
2. Отправляет на все часы из списка CLOCKS
3. Приложение отображается в цикле с другими приложениями

## Цветовая схема

| Температура | Цвет | Пример |
|-------------|------|--------|
| < 0°C | Фиолетовый | Улица зимой |
| 0°C - 18°C | Синий | Холодное помещение |
| 18°C - 24°C | Зелёный | Комфортная температура |
| > 24°C | Красный | Жарко |

*Пороги настраиваются в константах сценария.*

## Формат отображения

```
[иконка] 23° Спальня
```

- Иконка термометра слева
- Температура (округлённая)
- Название комнаты

## Опции сценария

| Опция | Тип | По умолчанию | Описание |
|-------|-----|--------------|----------|
| Отладка | Boolean | false | Включить логирование |

## Устранение неполадок

### Приложение не появляется на часах

1. Проверьте IP-адрес часов в константе `CLOCKS`
2. Убедитесь что часы доступны: `ping <IP_часов>`
3. Включите опцию "Отладка" и проверьте логи SprutHub
4. Подождите 30 секунд после сохранения сценария (часы перезагружаются)

### Нет иконки термометра

1. Откройте веб-интерфейс часов
2. Загрузите иконку с ID `2056` из галереи AWTRIX

### Температура не обновляется

1. Проверьте что датчик работает в SprutHub
2. Убедитесь что сценарий включён для датчика
3. Проверьте логи SprutHub на наличие ошибок

### Встроенные приложения не отключаются

1. Настройки применяются при сохранении сценария (после тестов)
2. После применения настроек часы автоматически перезагружаются
3. Подождите 30 секунд — данные начнут отправляться
4. Если проблема сохраняется, перезагрузите часы вручную

### В логах "Часы перезагружаются, осталось X сек"

Это нормально. Сценарий ждёт завершения перезагрузки часов перед отправкой данных.

## Тестирование

Тесты запускаются автоматически при каждом сохранении сценария. После успешного прохождения тестов применяются настройки к часам.

Для локального тестирования:

```bash
cd /path/to/spruthub
node logic/test-runner.js
```

## Структура файлов

```
logic/
├── awtrixTemperature.js  # Основной сценарий
└── test-runner.js        # Тестовый раннер для Node.js

docs/
├── awtrixTemperature-setup.md  # Эта документация
└── awtrixTemperature-tests.md  # Документация по тестам
```
